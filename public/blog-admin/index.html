<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>READ — Administration Blog</title>
  <link rel="icon" href="/lovable-uploads/aad9910b-4e2b-46cf-933a-002fa4205756.png" />
</head>
<body>
  <!-- Conteneur pour l'interface Decap CMS -->
  <div id="nc-root"></div>

  <!-- 1. ON GARDE le flag : Décap n'auto-initialisera pas -->
  <script>
    window.CMS_MANUAL_INIT = true;
    console.log('[DECAP] Manual init flag set');
  </script>

  <!-- 2. On charge Décap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.6.4/dist/decap-cms.js"></script>

  <!-- 3. Configuration et initialisation améliorée -->
  <script>
    console.log('[DECAP] Starting configuration load');
    
    // Vérifier si on a déjà un token en localStorage
    function checkExistingAuth() {
      try {
        const stored = localStorage.getItem('decap-cms-user') || localStorage.getItem('netlify-cms-user');
        if (stored) {
          const data = JSON.parse(stored);
          console.log('[DECAP] Found existing auth token:', { ...data, token: 'HIDDEN' });
          return data;
        }
      } catch (err) {
        console.warn('[DECAP] Error checking existing auth:', err);
      }
      return null;
    }

    // Écouter les messages d'authentification avec logs étendus
    function setupAuthListener() {
      console.log('[DECAP] Setting up auth message listener');
      
      window.addEventListener('message', function(event) {
        console.log('[DECAP] PARENT-MSG received:', event.data);
        
        if (typeof event.data === 'string' && event.data.startsWith('authorization:github:')) {
          try {
            const payload = JSON.parse(event.data.replace('authorization:github:', ''));
            console.log('[DECAP] Processing auth payload:', { ...payload, token: 'HIDDEN' });
            
            // Stocker le token
            localStorage.setItem('decap-cms-user', JSON.stringify(payload));
            localStorage.setItem('netlify-cms-user', JSON.stringify(payload));
            console.log('[DECAP] ✅ Token stored successfully');
            
            // Vérifier que Decap CMS est prêt avant de recharger
            setTimeout(() => {
              console.log('[DECAP] Reloading to apply authentication');
              window.location.reload();
            }, 500);
            
          } catch (err) {
            console.error('[DECAP] Error processing auth message:', err);
          }
        }
      });
      
      // Log pour vérifier que l'événement est bien attaché
      console.log('[DECAP] Message listener attached to window');
    }

    // Initialiser Decap CMS
    function initializeCMS() {
      console.log('[DECAP] Initializing CMS');
      
      fetch('/blog-admin/config.yml')
        .then(r => r.text())
        .then(cfg => {
          console.log('[DECAP] Config loaded, calling CMS.init()');
          CMS.init({ config: cfg, configType: 'yaml' });
          
          // Vérifier le statut d'auth après l'init
          setTimeout(() => {
            const authStatus = checkExistingAuth();
            console.log('[DECAP] Post-init auth status:', !!authStatus);
            
            if (authStatus) {
              console.log('[DECAP] ✅ User should be authenticated');
            } else {
              console.log('[DECAP] ❌ No authentication found');
            }
          }, 1000);
        })
        .catch(err => {
          console.error('[DECAP] Config.yml error:', err);
        });
    }

    // Fonction de diagnostic pour vérifier l'état
    function diagnoseState() {
      console.log('[DECAP] === DIAGNOSTIC ===');
      console.log('[DECAP] Current URL:', window.location.href);
      console.log('[DECAP] LocalStorage decap-cms-user:', localStorage.getItem('decap-cms-user'));
      console.log('[DECAP] LocalStorage netlify-cms-user:', localStorage.getItem('netlify-cms-user'));
      console.log('[DECAP] CMS object available:', typeof window.CMS !== 'undefined');
      console.log('[DECAP] #nc-root element present:', !!document.getElementById('nc-root'));
      console.log('[DECAP] === END DIAGNOSTIC ===');
    }

    // Démarrage
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[DECAP] DOM loaded, starting setup');
      
      // Diagnostic initial
      diagnoseState();
      
      // Configurer l'écoute des messages d'auth AVANT l'init
      setupAuthListener();
      
      // Vérifier l'auth existante
      const existingAuth = checkExistingAuth();
      if (existingAuth) {
        console.log('[DECAP] Using existing authentication');
      }
      
      // Initialiser le CMS avec un léger délai pour s'assurer que les listeners sont prêts
      setTimeout(initializeCMS, 300);
      
      // Diagnostic périodique (utile pour le debug)
      setInterval(diagnoseState, 10000);
    });
  </script>

</body>
</html>
